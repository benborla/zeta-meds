{% import "@SyliusShop/Common/Macro/money.html.twig" as money %}

<p class="lead">Select quantity below</p>

{% set productPrice = money.calculatePrice(product|sylius_resolve_variant)|replace({ ('$') : ''}) %}
{% set hasManyVariants = product.variants|length %}
<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
    {% for key, variant in product.variants %}
    {% set remainingStock = variant.onHand - variant.onHold %}
    {% set variantCode = hasManyVariants > 1 ? variant.code : '' %}
    <div class="panel panel-default">
        <div class="panel-heading-quantity panel-heading p-1 mb-1 bg-primary text-white" role="tab" id="heading_{{ variant.id }}">
            <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#item_{{ variant.id }}" aria-expanded="true" aria-controls="item_{{ variant.id }}">
                    <div class="float-right mt-1">
                        <i class="fa fa-chevron-down"></i>
                    </div>
                    <span class="text-white mt-1">
                        {{ product.name }} {{ variant.name }} (Remaining: {{ remainingStock|number_format }}pcs)
                    </span>
                </a>
            </h4>
        </div>
        <span class="clearfix"></span>
        <div id="item_{{ variant.id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_{{ variant.id }}">
            <div class="panel-body">
                {% set tier_prices = variant.getTierPricesForChannel(sylius.channel,sylius.customer) %}
                {% set variantPrice = money.calculatePrice(variant)|replace({ ('$') : '' }) %}
                <table class="ui stackable celled table">
                    <tbody>
                        <tr>
                            <td class="form-inline">
                                <input type="number" id="sylius_add_to_cart_cartItem_quantity_manual_{{ variant.code|lower }}_{{ variant.id }}" name="sylius_add_to_cart[cartItem][quantity]" required="required" min="1" class="form-control" value="1" style="width: 78px">&nbsp;<span>Tablets</span>
                                {{ sonata_block_render_event('sylius.shop.product.show.add_to_cart_form', {'product': product, 'order_item': order_item}) }}
                            </td>
                            <td><p class="mt-1">{{ money.calculatePrice(variant) }} per tablet</p></td>
                            <td><button
                                    type="button"
                                    class="btn btn-primary"
                                    data-target="sylius_add_to_cart_cartItem_quantity_manual_{{ variant.code|lower }}_{{ variant.id }}"
                                    data-variant="{{ variantCode }}">
                                    <i class="fa fa-shopping-bag"></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-danger lea">Value Saver!</td>
                        </tr>

                    {% if tier_prices|length > 0 %}
                        {% for tierPrice in tier_prices %}
                            {% set savedPrice =  100 - (tierPrice.price / variantPrice) %}
                            {% set inputQuantity = form_row(form.cartItem.quantity, { 'label': ' ', 'value': tierPrice.qty, 'attr': {'style': 'display: block'} }) %}
                            <tr>
                                <td>
                                    <input type="number" id="sylius_add_to_cart_cartItem_quantity_{{ variant.code|lower }}_{{ variant.id }}_{{ tierPrice.id }}" name="sylius_add_to_cart[cartItem][quantity]" required="required" min="1" class="form-control" value="{{ tierPrice.qty }}" style="display: none">
                                    <p class="mt-1">{{ tierPrice.qty|number_format }} Tablets</p>
                                </td>
                                <td><p class="mt-1">{{ money.convertAndFormat(tierPrice.price, sylius.channel.baseCurrency) }} per tablet <span class="text-danger">(Save {{ savedPrice|number_format }}%)</span></p></td>
                                <td><button type="button"
                                        class="btn btn-primary"
                                        data-variant="{{ variantCode }}"
                                        data-target="sylius_add_to_cart_cartItem_quantity_{{ variant.code|lower }}_{{ variant.id }}_{{ tierPrice.id }}"
                                        data-quantity="{{ tierPrice.qty }}"
                                    ><i class="fa fa-shopping-bag"></i></button></td>
                            </tr>
                        {% endfor %}
                    {% else %}
                            <tr>
                                <td>
                                    <p class="mt-1">{{ tierPrice.qty|number_format }} Tablets</p>
                                </td>
                                <td><p class="mt-1">{{ money.convertAndFormat(tierPrice.price, sylius.channel.baseCurrency) }}</p></td>
                                <td><button type="button" class="btn btn-primary"><i class="fa fa-plus"></i></button></td>
                            </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
